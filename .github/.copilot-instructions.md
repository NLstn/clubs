# Club Management Application - Copilot Instructions

**ALWAYS reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.**

## Project Overview
This is a club management application with a monorepo structure containing a Go backend and React TypeScript frontend. The application allows users to manage clubs, members, shifts, fines, and join requests through a RESTful API.

## Bootstrap and Build Instructions

**CRITICAL: NEVER CANCEL any build or test commands. Always set appropriate timeouts and wait for completion.**

### Initial Setup (Fresh Clone)
1. **Install Go 1.24.0** (already available in GitHub Actions environment)
   - Verify with: `go version` (should show go1.24.0)

2. **Install Node.js 20+** (already available in GitHub Actions environment)
   - Verify with: `node --version && npm --version` (should show v20.19.4+ and 10.8.2+)

3. **Install PostgreSQL database:**
   ```bash
   sudo apt-get update
   sudo apt-get install -y postgresql postgresql-contrib
   sudo systemctl start postgresql
   sudo -u postgres createuser --createdb --login runner
   sudo -u postgres psql -c "ALTER USER runner WITH PASSWORD 'password';"
   sudo -u postgres psql -c "CREATE DATABASE clubs OWNER runner;"
   ```
   **Time: ~30 seconds. Set timeout to 120+ seconds.**

### Backend Setup and Build
**Working directory: `/Backend`**

1. **Download dependencies:**
   ```bash
   go mod download
   ```
   **Time: <1 second. Set timeout to 60+ seconds.**

2. **Verify dependencies:**
   ```bash
   go mod verify
   ```
   **Time: <1 second. Set timeout to 60+ seconds.**

3. **Build the backend:**
   ```bash
   go build -v ./...
   ```
   **Time: ~53 seconds. NEVER CANCEL. Set timeout to 120+ seconds.**

4. **Run tests:**
   ```bash
   go test -v -race ./...
   ```
   **Time: ~60 seconds. NEVER CANCEL. Set timeout to 120+ seconds.**

### Frontend Setup and Build
**Working directory: `/Frontend`**

1. **Install dependencies:**
   ```bash
   npm ci
   ```
   **Time: ~3 seconds. Set timeout to 300+ seconds (npm can be slow).**

2. **Run linting:**
   ```bash
   npm run lint
   ```
   **Time: ~3 seconds. Set timeout to 60+ seconds.**

3. **Build the frontend:**
   ```bash
   npm run build
   ```
   **Time: ~7 seconds. Set timeout to 60+ seconds.**

4. **Run tests:**
   ```bash
   npm run test
   ```
   **Time: ~13 seconds. Set timeout to 60+ seconds.**

### Running the Application
1. **Set up environment files:**
   - Backend: Copy `Backend/.env.example` to `Backend/.env` and configure database settings
   - Frontend: Copy `Frontend/.env.example` to `Frontend/.env.development`

2. **Start the backend:**
   ```bash
   cd Backend && go run main.go
   ```
   **Starts on port 8080. Health check: `curl http://localhost:8080/health`**

3. **Start the frontend (in separate terminal):**
   ```bash
   cd Frontend && npm run dev
   ```
   **Starts on port 5173. Open http://localhost:5173 in browser.**

### Validation Requirements
**MANDATORY: After any changes, run these validation scenarios:**

1. **Build Validation:**
   - Backend builds without errors in <120 seconds
   - Frontend builds without errors in <60 seconds
   - All tests pass in <120 seconds (backend) and <60 seconds (frontend)

2. **Runtime Validation:**
   - Backend starts and health endpoint responds: `curl http://localhost:8080/health`
   - Frontend starts and loads in browser at http://localhost:5173
   - Can navigate between pages without errors

3. **End-to-End Validation:**
   - Health endpoint returns `{"status":"healthy","services":{"api":"healthy","database":"healthy"}}`
   - Frontend connects to backend (check browser console for API errors)
   - No critical console errors in browser developer tools

## Complete Setup Workflow (Fresh Clone to Running Application)

**Execute these commands in order from the repository root directory:**

### Step 1: Verify Prerequisites
```bash
go version    # Must show go1.24.0
node --version    # Must show v20.19.4+
npm --version     # Must show 10.8.2+
```

### Step 2: Set Up Database (One-time setup)
```bash
# Install and configure PostgreSQL
sudo apt-get update && sudo apt-get install -y postgresql postgresql-contrib
sudo systemctl start postgresql
sudo -u postgres createuser --createdb --login runner || true
sudo -u postgres psql -c "ALTER USER runner WITH PASSWORD 'password';"
sudo -u postgres psql -c "CREATE DATABASE clubs OWNER runner;" || sudo -u postgres psql -c "ALTER DATABASE clubs OWNER runner;"
```
**Time: ~30 seconds. TIMEOUT: 300+ seconds.**

### Step 3: Backend Setup and Verification
```bash
cd Backend
go mod download    # TIMEOUT: 60+ seconds
go mod verify      # TIMEOUT: 60+ seconds  
go build -v ./...  # TIMEOUT: 120+ seconds, NEVER CANCEL
go test -v -race ./...  # TIMEOUT: 120+ seconds, NEVER CANCEL

# Set up environment
cp .env.example .env
# Edit .env file with database credentials (see Environment Variables section)
```

### Step 4: Frontend Setup and Verification  
```bash
cd ../Frontend
npm ci             # TIMEOUT: 300+ seconds
npm run lint       # TIMEOUT: 60+ seconds
npm run build      # TIMEOUT: 60+ seconds
npm run test       # TIMEOUT: 60+ seconds

# Set up environment
cp .env.example .env.development
# Edit .env.development with API configuration (see Environment Variables section)
```

### Step 5: Manual Application Testing
```bash
# Terminal 1: Start backend
cd Backend && go run main.go
# Wait for "Starting server on :8080" message

# Terminal 2: Verify backend health
curl http://localhost:8080/health
# Should return: {"status":"healthy","services":{"api":"healthy","database":"healthy"}}

# Terminal 2: Start frontend  
cd Frontend && npm run dev
# Wait for "Local: http://localhost:5173/" message

# Manual verification:
# 1. Open http://localhost:5173 in browser
# 2. Verify page loads without console errors
# 3. Check that frontend can communicate with backend
# 4. Test basic navigation between pages
```

**Total setup time: ~2-3 minutes (excluding database installation)**

## Architecture & Technology Stack

### Backend (`/Backend`)
- **Language**: Go 1.24.0
- **HTTP Framework**: Built-in `net/http` library (NOT Gorilla Mux - uses standard library only)
- **Database**: PostgreSQL with GORM ORM
- **Authentication**: JWT-based with magic link email authentication
- **External Services**: Azure services for email (ACS) and identity
- **Key Features**:
  - Rate limiting with IP-based limiters
  - Custom middleware for CORS, logging, and authentication
  - RESTful API design with proper HTTP status codes
  - Database migrations handled in main.go

### Frontend (`/Frontend`)
- **Framework**: React 19 with TypeScript
- **Build Tool**: Vite
- **Routing**: React Router DOM v7
- **HTTP Client**: Axios
- **Styling**: CSS modules/vanilla CSS
- **Key Features**:
  - Protected routes with JWT authentication
  - Context-based auth state management
  - TypeScript for type safety

## Code Organization

### Backend Structure
- `main.go` - Application entry point, database migrations, server setup
- `handlers/` - HTTP request handlers organized by feature
  - `api.go` - Main handler registration and utility functions
  - `auth.go` - Authentication endpoints (magic links, JWT)
  - `clubs.go` - Club CRUD operations
  - `members.go` - Member management
  - `fines.go` - Fine management
  - `shift_schedules.go` - Shift scheduling
  - `join_requests.go` - Club membership requests
  - `user.go` - User profile management
  - `middlewares.go` - CORS, logging, rate limiting middleware
- `models/` - Database models and business logic
- `auth/` - JWT and authentication utilities
- `database/` - Database connection and configuration
- `azure/` - Azure SDK integrations
- `tools/` - Utility functions (frontend URL generation)

### Frontend Structure
- `src/pages/` - Page components organized by feature
- `src/components/` - Reusable components
- `src/context/` - React context providers (auth)
- `src/utils/` - Utility functions and API client

## Key Implementation Details

### HTTP Routing
- Uses standard `http.ServeMux` for routing with path parameters like `{clubid}`
- Custom `extractPathParam()` function for parameter extraction
- Method-based routing handled in handler functions with switch statements

### Authentication Flow
1. Magic link email authentication (no passwords)
2. JWT access tokens (short-lived) + refresh tokens (longer-lived)
3. `AuthMiddleware` validates Bearer tokens
4. User context passed through request context

### Database
- PostgreSQL with GORM ORM
- UUID primary keys for all entities
- Automatic migrations in main.go
- Environment-based configuration

### Rate Limiting
- IP-based rate limiting with different limits for auth vs API endpoints
- Custom `IPRateLimiter` implementation with cleanup routines
- Auth endpoints: 5 requests/minute
- API endpoints: 30 requests/5 seconds

## Common Commands and Expected Times

### Backend Commands (from `/Backend` directory)
| Command | Expected Time | Timeout | Description |
|---------|---------------|---------|-------------|
| `go version` | <1s | 30s | Verify Go installation |
| `go mod download` | <1s | 60s | Download dependencies |
| `go mod verify` | <1s | 60s | Verify dependencies |
| `go build -v ./...` | ~53s | **120s+** | **NEVER CANCEL** - Build all packages |
| `go test -v -race ./...` | ~60s | **120s+** | **NEVER CANCEL** - Run all tests |
| `go run main.go` | ~2s startup | N/A | Start server (runs until stopped) |

### Frontend Commands (from `/Frontend` directory)  
| Command | Expected Time | Timeout | Description |
|---------|---------------|---------|-------------|
| `node --version` | <1s | 30s | Verify Node.js installation |
| `npm --version` | <1s | 30s | Verify npm installation |
| `npm ci` | ~3s | 300s | Install dependencies (can be slow) |
| `npm run lint` | ~3s | 60s | Run ESLint |
| `npm run build` | ~7s | 60s | Build for production |
| `npm run test` | ~13s | 60s | Run test suite |
| `npm run dev` | ~1s startup | N/A | Start dev server (runs until stopped) |

### Database Setup Commands
| Command | Expected Time | Timeout | Description |
|---------|---------------|---------|-------------|
| `sudo apt-get update` | ~5s | 120s | Update package lists |
| `sudo apt-get install -y postgresql postgresql-contrib` | ~20s | 300s | Install PostgreSQL |
| Database user setup | ~2s | 60s | Create user and database |

**CRITICAL REMINDERS:**
- **NEVER CANCEL builds or tests** - they may take 60+ seconds
- **Always set timeouts 2x longer than expected time** 
- **If a command appears to hang, wait at least 120 seconds before investigating**

## Development Guidelines

### Testing Requirements for Issue Fixes
**CRITICAL REQUIREMENT**: Every issue fixed by Copilot must include a unit test to verify the issue does not regress in the future.

#### When This Applies
- Bug fixes that resolve reported issues
- Logic corrections or error handling improvements
- API behavior changes that address specific problems
- Data processing or validation fixes

#### Testing Standards
- **Backend (Go)**: Add tests to appropriate `*_test.go` files using the standard Go testing package
  - Place tests in the same package/directory as the code being tested
  - Use table-driven tests for multiple scenarios when appropriate
  - Follow existing test patterns (see `Backend/handlers/*_test.go` for examples)
  - Test both success and error cases

- **Frontend (TypeScript/React)**: Add tests to `__tests__` directories using Vitest and React Testing Library
  - Test components, utilities, and context providers affected by the fix
  - Include user interaction testing for UI-related fixes
  - Follow existing test patterns (see examples in `Frontend/src/**/__tests__/`)
  - Mock external dependencies appropriately

#### Test Requirements
1. **Regression Prevention**: Tests must specifically validate the scenario that was broken before the fix
2. **Coverage**: Tests should cover the primary fix and related edge cases
3. **Clarity**: Test names should clearly describe what issue they prevent (e.g., "should handle RFC3339 date parsing correctly")
4. **Integration**: New tests must not break existing test suites

#### Validation Process
- **Backend tests:** Run `go test ./...` in Backend directory (**TIMEOUT: 120+ seconds, NEVER CANCEL**)
- **Frontend tests:** Run `npm run test` in Frontend directory (**TIMEOUT: 60+ seconds**)
- Ensure all existing tests continue to pass
- Verify new tests fail when the fix is temporarily reverted (proving they catch the regression)

### Backend Conventions
- Use standard HTTP status codes consistently
- Always set `Content-Type: application/json` for JSON responses
- Extract user from request context using `extractUser(r)`
- Use GORM for database operations
- Handle errors with proper HTTP status codes
- Use rate limiting middleware for all endpoints
- Follow RESTful API design patterns
- **All timestamp fields in JSON responses must use camelCase format (`createdAt`, `updatedAt`) and RFC3339 formatting for frontend compatibility**
- **When adding new models, always add them to the AutoMigrate call in `main.go` to ensure database tables are created properly**

#### Testing in Backend
- **Use the central test database setup**: All tests should use `handlers.SetupTestDB(t)` and `defer handlers.TeardownTestDB(t)` for database setup and cleanup
- **DO NOT create custom test database setup functions** - The central setup in `Backend/handlers/test_helpers.go` provides a consistent in-memory SQLite database for all tests
- **For model tests**: Use `package models_test` to avoid import cycles, import the `handlers` and `models` packages, and access the database via `database.Db`
- **For handler tests**: Use the existing test helper functions like `CreateTestUser()`, `CreateTestClub()`, etc.
- **When adding new database tables**: Update the central test database setup in `Backend/handlers/test_helpers.go` to include the new table schema
- **Example model test pattern**:
  ```go
  package models_test
  
  import (
      "testing"
      "github.com/NLstn/clubs/handlers"
      "github.com/NLstn/clubs/models"
      "github.com/NLstn/clubs/database"
  )
  
  func TestSomeModelFunction(t *testing.T) {
      handlers.SetupTestDB(t)
      defer handlers.TeardownTestDB(t)
      
      // Use database.Db for direct database access
      // Use handlers.CreateTestUser(), handlers.CreateTestClub() for standard test data
  }
  ```

### Frontend Conventions
- Use TypeScript for all components
- Implement proper error handling for API calls
- Use protected routes for authenticated pages
- Follow React 19 patterns and best practices
- Use context for global state management
- **MANDATORY: Follow UI Design Guidelines** - All UI development must strictly adhere to the design system in `/Documentation/UI_DESIGN_GUIDELINE.md` and related design documentation
- **Prefer central index.css styling over inline styles** - Add classes to index.css instead of using style={{}} objects, following the documented design system
- **Expect all date/timestamp fields from API responses to be in camelCase format and parse them using `new Date()` for display**
- **Always run `npm run lint` in the Frontend folder and fix any ESLint issues before committing changes (TIMEOUT: 60+ seconds)**

#### Internationalization
- All UI texts in this application must be internationalized using the custom hook useTranslation() from `Frontend/src/hooks/useTranslation.ts`
- Use the `t()` function to retrieve translated strings
- Ensure all new text strings are added to the translation files in `Frontend/src/locales/`
- Every new text must be added to the translation files in english and german

### Code Style
- Go: Follow standard Go conventions, use proper error handling
- TypeScript/React: Use functional components with hooks
- Consistent naming conventions across both codebases
- Proper separation of concerns between handlers, models, and business logic

## Environment Variables and Configuration

### Required Environment Setup
**Before running the application, set up environment files:**

#### Backend Environment (`Backend/.env`)
Copy `Backend/.env.example` to `Backend/.env` and configure:
```bash
# Database Configuration
DATABASE_URL=localhost
DATABASE_PORT=5432
DATABASE_USER=runner
DATABASE_USER_PASSWORD=password
DATABASE_NAME=clubs
DATABASE_SSL_MODE=disable

# Application Configuration
FRONTEND_URL=http://localhost:5173
JWT_SECRET=your-jwt-secret-here

# Azure Configuration (for production)
AZURE_TENANT_ID=your-tenant-id
AZURE_CLIENT_ID=your-client-id
AZURE_CLIENT_SECRET=your-client-secret
AZURE_STORAGE_ACCOUNT_NAME=your-storage-account
AZURE_STORAGE_CONTAINER_NAME=club-assets
AZURE_CDN_ENDPOINT=https://your-cdn-endpoint.azureedge.net
AZURE_ACS_ENDPOINT=your-acs-endpoint

# Keycloak Configuration
KEYCLOAK_SERVER_URL=https://your-keycloak-server.com
KEYCLOAK_REALM=your-realm
KEYCLOAK_CLIENT_ID=your-client-id
```

#### Frontend Environment (`Frontend/.env.development`)
Copy `Frontend/.env.example` to `Frontend/.env.development` and configure:
```bash
# API Configuration
VITE_API_HOST=http://localhost:8080

# Keycloak Configuration
VITE_KEYCLOAK_URL=https://your-keycloak-server.com/realms/your-realm
VITE_KEYCLOAK_CLIENT_ID=your-client-id
```

### Development Environment Test Credentials
For testing in the development environment:
- **Username**: copilot@test.com
- **Password**: copilot

## API Documentation
Complete API documentation is available in `/Documentation/API.md`. This file contains:
- All endpoint specifications (25+ endpoints)
- Authentication flow and JWT token handling
- Request/response formats with JSON examples
- Rate limiting details
- Error response formats
- Complete parameter descriptions

**When making changes to the API, always reference and update this documentation.**

## UI Design Guidelines (MANDATORY)
**All UI development must strictly follow the established design system** - This is a mandatory requirement for maintaining consistency and quality.

### Design System Requirements
1. **Mandatory Compliance**: All UI changes must follow the comprehensive design guidelines located in `/Documentation/Frontend/README.md` - This unified documentation contains:
   - Complete color system with CSS variables and usage guidelines
   - Spacing system variables (`--space-xs` through `--space-xl`) with responsive values
   - Typography hierarchy and responsive scaling guidelines
   - Component library documentation and implementation examples
   - Accessibility guidelines (WCAG 2.1 AA compliance)
   - Mobile-first responsive design principles
   - Component-specific documentation in `/Documentation/Frontend/components/`

2. **Mandatory Design Principles**:
   - **Dark Theme**: Use `--color-background` (#242424) with `--color-primary` (#4CAF50) green accents
   - **Typography**: Inter font family with documented hierarchy and responsive scaling
   - **Spacing**: Use CSS variables (`--space-xs`, `--space-sm`, `--space-md`, `--space-lg`, `--space-xl`) for consistent spacing
   - **Colors**: Use semantic CSS custom properties (e.g., `--color-primary`, `--color-secondary`, `--color-text`)
   - **Accessibility**: WCAG 2.1 AA compliance with proper contrast ratios (4.5:1 minimum)
   - **Touch Targets**: 44px minimum (48px on mobile) for all interactive elements
   - **Responsive Design**: Mobile-first approach with documented breakpoints (≤480px, 481px-768px, >768px)

3. **Component Implementation Requirements**:
   - Follow documented component patterns in `/Documentation/Frontend/README.md`
   - Use provided CSS implementation examples for buttons, forms, and layouts
   - Utilize existing UI components from `Frontend/src/components/ui/` (Table, TypeAheadDropdown)
   - Maintain responsive behavior specifications with mobile utility classes
   - Ensure keyboard navigation support and proper focus management
   - Validate color contrast compliance using documented color variables

4. **Before Any UI Changes**:
   - Review `/Documentation/Frontend/README.md` for design system guidelines
   - Check existing component library for reusable components
   - Ensure changes align with established patterns and spacing variables
   - Verify accessibility requirements are met using documented guidelines
   - Test responsive behavior across documented breakpoints

**Failure to follow these design guidelines will result in changes being rejected.**

## Documentation Maintenance
**All documentation must be placed in the Documentation folder** - This includes API documentation, database schemas, deployment guides, and any other technical documentation.

When making API-related changes that should be documented:
1. **Always update `/Documentation/API.md`** when:
   - Adding new endpoints
   - Modifying existing endpoint parameters, responses, or behavior
   - Changing authentication requirements
   - Updating rate limiting rules
   - Adding new error responses
   - Modifying request/response formats

2. **API Documentation Update Process**:
   - Review existing documentation in `/Documentation/API.md`
   - Update the relevant sections to reflect your changes
   - Ensure JSON examples are accurate and complete
   - Maintain consistent formatting with existing documentation
   - Include proper HTTP status codes and error responses

3. **General Documentation Guidelines**:
   - Place all new documentation files in the Documentation folder
   - Use clear, descriptive filenames (e.g., `Documentation/database-schema.md`)
   - Follow markdown formatting conventions
   - Keep documentation close to the code it describes

## Important Notes

### Critical Build and Test Requirements
- **NEVER CANCEL builds or tests** - Backend builds take ~53s, tests take ~60s
- **Always set timeouts 2x longer than expected** - Use 120+ seconds for backend operations, 60+ seconds for frontend
- **Go builds may appear to hang** - This is normal, wait at least 120 seconds before investigating
- **Frontend npm operations can be slow** - Set 300+ second timeouts for npm ci
- **All validation must be manual** - Run complete user scenarios after changes

### Quick Reference - Validated Commands
**These commands are tested and work correctly:**
```bash
# Backend (from /Backend directory) - TIMEOUTS REQUIRED
go mod download          # <1s (timeout: 60s)
go mod verify           # <1s (timeout: 60s)  
go build -v ./...       # ~53s (timeout: 120s+) NEVER CANCEL
go test -v -race ./...  # ~60s (timeout: 120s+) NEVER CANCEL
go run main.go          # Starts server on :8080

# Frontend (from /Frontend directory) - TIMEOUTS REQUIRED  
npm ci                  # ~3s (timeout: 300s)
npm run lint           # ~3s (timeout: 60s)
npm run build          # ~7s (timeout: 60s)
npm run test           # ~13s (timeout: 60s)
npm run dev            # Starts server on :5173

# Database setup (one-time)
sudo apt-get update && sudo apt-get install -y postgresql postgresql-contrib
sudo systemctl start postgresql
sudo -u postgres createuser --createdb --login runner
sudo -u postgres psql -c "ALTER USER runner WITH PASSWORD 'password';"
sudo -u postgres psql -c "CREATE DATABASE clubs OWNER runner;"
```

### Mandatory Validation After Changes
1. **Build validation** - All builds complete without errors within expected timeframes
2. **Test validation** - All tests pass within expected timeframes  
3. **Runtime validation** - Both applications start successfully
4. **API validation** - Health endpoint responds correctly: `curl http://localhost:8080/health`
5. **UI validation** - Frontend loads at http://localhost:5173 without console errors

## Technical Details

### Project Structure
- **DO NOT use Gorilla Mux** - This project uses only the standard `net/http` library
- All routes use `http.ServeMux` with built-in path parameter support
- Rate limiting is implemented at the application level, not reverse proxy level
- Authentication is stateless JWT-based, no sessions
- Database connection pooling handled by GORM
- CORS is handled by custom middleware, not external packages

**FINAL REMINDER: All changes must be validated with complete build, test, and manual verification cycles. Failure to follow timing and validation requirements will result in changes being rejected.**
